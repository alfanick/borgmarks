stages:
  - test
  - build
  - publish

variables:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONDONTWRITEBYTECODE: "1"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  CONTAINER_IMAGE: "${CI_REGISTRY}/alfanick/borgmarks"

version_guard_main:
  stage: test
  image: alpine:3.20
  script:
    - |
      set -eu
      apk add --no-cache git
      CUR_VERSION="$(tr -d '[:space:]' < VERSION)"
      test -n "$CUR_VERSION"
      if [ -z "${CI_COMMIT_BEFORE_SHA}" ] || [ "${CI_COMMIT_BEFORE_SHA}" = "0000000000000000000000000000000000000000" ]; then
        echo "Initial main push: skipping VERSION-change diff check."
        exit 0
      fi
      PREV_VERSION="$(git show "${CI_COMMIT_BEFORE_SHA}:VERSION" 2>/dev/null | tr -d '[:space:]' || true)"
      test -n "$PREV_VERSION"
      if [ "$CUR_VERSION" = "$PREV_VERSION" ]; then
        echo "Push to main rejected: VERSION must change on every main push/merge."
        exit 1
      fi
      echo "VERSION changed: ${PREV_VERSION} -> ${CUR_VERSION}"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

unit_tests:
  stage: test
  image: python:3.12-slim
  cache:
    key:
      files:
        - requirements.txt
    paths:
      - .cache/pip
    policy: pull-push
  script:
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
    - mkdir -p test-reports
    - pytest -q --junitxml=test-reports/pytest-junit.xml
  artifacts:
    when: always
    paths:
      - test-reports/pytest-junit.xml
    reports:
      junit: test-reports/pytest-junit.xml
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

cli_smoke:
  stage: test
  image: python:3.12-slim
  cache:
    key:
      files:
        - requirements.txt
    paths:
      - .cache/pip
    policy: pull-push
  script:
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
    - mkdir -p out-ci/firefox-profile
    - python -m borgmarks organize --ios-html tests/fixtures/sample_bookmarks.html --firefox-profile out-ci/firefox-profile --no-fetch --no-openai
    - test -s out-ci/firefox-profile/bookmarks.organized.html
    - grep -q "Bookmarks Toolbar" out-ci/firefox-profile/bookmarks.organized.html
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

container_build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  needs: ["unit_tests", "cli_smoke"]
  script:
    - /kaniko/executor --context "${CI_PROJECT_DIR}" --dockerfile "${CI_PROJECT_DIR}/Containerfile" --no-push
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

auto_tag_main:
  stage: publish
  image:
    name: alpine/git:2.45.2
    entrypoint: [""]
  needs: ["version_guard_main", "container_build"]
  script:
    - CUR_VERSION="$(tr -d '[:space:]' < VERSION)"
    - TAG="v${CUR_VERSION}"
    - |
      if git ls-remote --exit-code --tags origin "refs/tags/${TAG}" >/dev/null 2>&1; then
        echo "Tag ${TAG} already exists."
        exit 0
      fi
    - git config user.name "Codex CI"
    - git config user.email "juskowiak+ai@amadeusz.me"
    - git tag -a "$TAG" -m "Release ${TAG}"
    - |
      if git push "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "$TAG"; then
        echo "Pushed ${TAG} using CI_JOB_TOKEN."
        exit 0
      fi
      echo "CI_JOB_TOKEN push failed for ${TAG}, trying GITLAB_PUSH_TOKEN fallback."
      if [ -n "${GITLAB_PUSH_TOKEN:-}" ]; then
        if git push "https://oauth2:${GITLAB_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "$TAG"; then
          echo "Pushed ${TAG} using GITLAB_PUSH_TOKEN fallback."
          exit 0
        fi
      fi
      echo "ERROR: unable to push ${TAG} with CI_JOB_TOKEN or GITLAB_PUSH_TOKEN."
      exit 1
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

container_publish:
  stage: publish
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  needs: ["unit_tests", "cli_smoke", "container_build"]
  script:
    - mkdir -p /kaniko/.docker
    - |
      cat > /kaniko/.docker/config.json <<EOF_JSON
      {"auths":{"${CI_REGISTRY}":{"username":"${CI_REGISTRY_USER}","password":"${CI_REGISTRY_PASSWORD}"}}}
      EOF_JSON
    - |
      DEST_ARGS="--destination=${CONTAINER_IMAGE}:${CI_COMMIT_SHORT_SHA}"
      if [ "${CI_COMMIT_BRANCH}" = "${CI_DEFAULT_BRANCH}" ]; then
        CUR_VERSION="$(tr -d '[:space:]' < VERSION)"
        DEST_ARGS="${DEST_ARGS} --destination=${CONTAINER_IMAGE}:latest --destination=${CONTAINER_IMAGE}:${CI_COMMIT_REF_SLUG} --destination=${CONTAINER_IMAGE}:${CUR_VERSION} --destination=${CONTAINER_IMAGE}:v${CUR_VERSION}"
      fi
      if [ -n "${CI_COMMIT_TAG}" ]; then
        DEST_ARGS="${DEST_ARGS} --destination=${CONTAINER_IMAGE}:${CI_COMMIT_TAG}"
        RAW_TAG="${CI_COMMIT_TAG#v}"
        if [ "${RAW_TAG}" != "${CI_COMMIT_TAG}" ]; then
          DEST_ARGS="${DEST_ARGS} --destination=${CONTAINER_IMAGE}:${RAW_TAG}"
        fi
      fi
      /kaniko/executor --context "${CI_PROJECT_DIR}" --dockerfile "${CI_PROJECT_DIR}/Containerfile" ${DEST_ARGS}
  rules:
    - if: $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+$/
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
