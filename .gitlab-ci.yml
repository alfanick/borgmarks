stages:
  - test
  - build
  - publish

variables:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONDONTWRITEBYTECODE: "1"

unit_tests:
  stage: test
  image: python:3.12-slim
  script:
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
    - pytest -q
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

container_build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  needs: ["unit_tests"]
  script:
    - /kaniko/executor --context "${CI_PROJECT_DIR}" --dockerfile "${CI_PROJECT_DIR}/Containerfile" --no-push
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH

container_publish:
  stage: publish
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  needs: ["unit_tests"]
  script:
    - mkdir -p /kaniko/.docker
    - |
      cat > /kaniko/.docker/config.json <<EOF
      {"auths":{"${CI_REGISTRY}":{"username":"${CI_REGISTRY_USER}","password":"${CI_REGISTRY_PASSWORD}"}}}
      EOF
    - |
      DEST_ARGS="--destination=${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}"
      if [ -n "${CI_COMMIT_TAG}" ]; then
        DEST_ARGS="${DEST_ARGS} --destination=${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}"
      fi
      if [ "${CI_COMMIT_BRANCH}" = "${CI_DEFAULT_BRANCH}" ]; then
        DEST_ARGS="${DEST_ARGS} --destination=${CI_REGISTRY_IMAGE}:latest --destination=${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_SLUG}"
      fi
      /kaniko/executor --context "${CI_PROJECT_DIR}" --dockerfile "${CI_PROJECT_DIR}/Containerfile" ${DEST_ARGS}
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
